<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Flappy Treasure Flight</title>
  <style>
    /* 
      In CodePen you have the option to split your code into three panels:
      - HTML: for the structure
      - CSS: for the styling
      - JavaScript: for the behavior
      Splitting can improve readability and organization. However, combining
      them in a single HTML file (with <style> and <script> tags) is perfectly
      acceptable for small projects or demos. Use whichever approach suits your workflow.
    */

    /* Reset & Base Styling */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      background: linear-gradient(to bottom, #87ceeb, #ffffff);
      overflow: hidden;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    /* Center the canvas and add a border */
    #gameCanvas {
      display: block;
      margin: 20px auto;
      background: #87ceeb;
      border: 3px solid #333;
      border-radius: 8px;
    }
    /* Score display styling */
    #scoreBoard {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 24px;
      color: #fff;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
      z-index: 10;
    }
    /* Game Over overlay */
    #gameOverScreen {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 36px;
      color: #fff;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
      display: none;
      z-index: 10;
      text-align: center;
      background: rgba(0, 0, 0, 0.6);
      padding: 20px 40px;
      border-radius: 10px;
    }
    #restartButton {
      padding: 10px 20px;
      font-size: 24px;
      background: gold;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <!-- Score and Game Over UI -->
  <div id="scoreBoard">Score: 0</div>
  <div id="gameOverScreen">
    <div id="gameOverText">Game Over</div>
    <button id="restartButton">Restart</button>
  </div>

  <!-- Game Canvas -->
  <canvas id="gameCanvas" width="480" height="640"></canvas>

  <script>
    /***** AUDIO SETUP *****/
    // Create an AudioContext for our sounds
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    // Play a soft beep (for jump and coin sounds)
    function playBeep(frequency, duration, volume = 0.1) {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.frequency.value = frequency;
      osc.type = 'sine';
      gain.gain.setValueAtTime(volume, audioCtx.currentTime);
      osc.start();
      osc.stop(audioCtx.currentTime + duration);
    }

    // Ambient background music: plays a soft chord every few seconds
    function playAmbientMusic() {
      const now = audioCtx.currentTime;
      const chordFrequencies = [261.63, 329.63, 392.00]; // C4, E4, G4
      const duration = 2; // seconds
      chordFrequencies.forEach(freq => {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.frequency.value = freq;
        osc.type = 'sine';
        gain.gain.setValueAtTime(0.03, now);
        osc.start(now);
        osc.stop(now + duration);
      });
      // Loop the ambient chord every 5 seconds
      setTimeout(playAmbientMusic, 5000);
    }
    // Start ambient music on first user interaction to satisfy autoplay policies.
    document.body.addEventListener('click', function initAudio() {
      if (audioCtx.state === 'suspended') audioCtx.resume();
      playAmbientMusic();
      document.body.removeEventListener('click', initAudio);
    });

    /***** GAME SETUP *****/
    // Get DOM elements
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreBoard = document.getElementById('scoreBoard');
    const gameOverScreen = document.getElementById('gameOverScreen');
    const restartButton = document.getElementById('restartButton');

    // Game constants
    const GRAVITY = 0.5;
    const JUMP_STRENGTH = -8;
    const PIPE_GAP = 150;
    const PIPE_WIDTH = 60;
    const PIPE_INTERVAL = 1800; // milliseconds
    const COIN_SIZE = 30;
    const COIN_INTERVAL = 2500; // milliseconds

    // Arrays for clouds, pipes, and coins
    let clouds = [];
    let pipes = [];
    let coins = [];
    let score = 0;
    let lastPipeTime = 0;
    let lastCoinTime = 0;
    let gameOver = false;
    let lastTime = 0;

    // Create a bird object with a nicer, bird-like SVG
    const birdImg = new Image();
    birdImg.src = "data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3E%3Cpath%20d='M10%2032%20C10%2020,30%2010,50%2020%20C60%2025,60%2035,50%2040%20C30%2050,10%2040,10%2032Z'%20fill='orange'%20stroke='brown'%20stroke-width='2'/%3E%3Ccircle%20cx='20'%20cy='28'%20r='3'%20fill='black'/%3E%3C/svg%3E";

    // Pipe images (improved visuals)
    const pipeNorthImg = new Image();
    pipeNorthImg.src = "data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20width='60'%20height='300'%3E%3Crect%20width='60'%20height='300'%20fill='%234CAF50'%20stroke='%232E7D32'%20stroke-width='4'/%3E%3C/svg%3E";
    const pipeSouthImg = new Image();
    pipeSouthImg.src = "data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20width='60'%20height='300'%3E%3Crect%20width='60'%20height='300'%20fill='%2366BB6A'%20stroke='%23388E3C'%20stroke-width='4'/%3E%3C/svg%3E";

    // Coin images: Gold coin and Diamond coin
    const goldCoinImg = new Image();
    goldCoinImg.src = "data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2032%2032'%3E%3Ccircle%20cx='16'%20cy='16'%20r='14'%20fill='gold'%20stroke='%232E7D32'%20stroke-width='2'/%3E%3C/svg%3E";
    const diamondImg = new Image();
    diamondImg.src = "data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2032%2032'%3E%3Cpolygon%20points='16,2%2030,16%2016,30%202,16'%20fill='deepskyblue'%20stroke='blue'%20stroke-width='2'/%3E%3C/svg%3E";

    // Bird object
    let bird = {
      x: 50,
      y: canvas.height / 2,
      width: 40,
      height: 32,
      velocity: 0
    };

    /***** CLOUDS *****/
    // Create some cloud objects for background ambience
    function spawnCloud() {
      clouds.push({
        x: canvas.width,
        y: Math.random() * (canvas.height / 2),
        speed: 0.5 + Math.random(),
        scale: 0.5 + Math.random() * 0.5
      });
    }
    // Spawn a new cloud every 3 seconds
    setInterval(spawnCloud, 3000);

    // Draw a cloud using simple arcs
    function drawCloud(cloud) {
      ctx.save();
      ctx.translate(cloud.x, cloud.y);
      ctx.scale(cloud.scale, cloud.scale);
      ctx.fillStyle = "rgba(255,255,255,0.8)";
      ctx.beginPath();
      ctx.arc(0, 0, 20, Math.PI * 0.5, Math.PI * 1.5);
      ctx.arc(25, -10, 20, Math.PI * 1, Math.PI * 2);
      ctx.arc(50, 0, 20, Math.PI * 1.5, Math.PI * 0.5);
      ctx.closePath();
      ctx.fill();
      ctx.restore();
    }

    /***** INPUT HANDLING *****/
    // Make the bird "flap" (jump) on key, click, or touch
    function flap() {
      if (!gameOver) {
        bird.velocity = JUMP_STRENGTH;
        playBeep(300, 0.1);
      }
    }
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space') flap();
    });
    canvas.addEventListener('click', flap);
    canvas.addEventListener('touchstart', (e) => {
      e.preventDefault();
      flap();
    });

    /***** GAME LOGIC *****/
    // Restart game on button click
    restartButton.addEventListener('click', restartGame);

    // Spawn pipes (obstacles)
    function spawnPipe() {
      const gapPosition = Math.random() * (canvas.height - PIPE_GAP - 100) + 50;
      // Top pipe
      pipes.push({
        x: canvas.width,
        y: gapPosition - PIPE_GAP - pipeNorthImg.height,
        isTop: true
      });
      // Bottom pipe
      pipes.push({
        x: canvas.width,
        y: gapPosition + PIPE_GAP,
        isTop: false
      });
    }

    // Spawn coins with random type ("gold" or "diamond")
    function spawnCoin() {
      const coinY = Math.random() * (canvas.height - COIN_SIZE - 100) + 50;
      const type = Math.random() < 0.6 ? "gold" : "diamond"; // 60% chance gold, 40% diamond
      coins.push({
        x: canvas.width,
        y: coinY,
        type: type,
        collected: false
      });
    }

    // Collision detection between two rectangles
    function detectCollision(r1, r2) {
      return (
        r1.x < r2.x + r2.width &&
        r1.x + r1.width > r2.x &&
        r1.y < r2.y + r2.height &&
        r1.y + r1.height > r2.y
      );
    }

    // End the game and show Game Over screen
    function endGame() {
      gameOver = true;
      gameOverScreen.style.display = 'block';
    }

    // Restart the game
    function restartGame() {
      bird.x = 50;
      bird.y = canvas.height / 2;
      bird.velocity = 0;
      pipes = [];
      coins = [];
      score = 0;
      lastPipeTime = 0;
      lastCoinTime = 0;
      gameOver = false;
      gameOverScreen.style.display = 'none';
      scoreBoard.textContent = "Score: " + score;
      lastTime = performance.now();
      requestAnimationFrame(loop);
    }

    /***** DRAWING FUNCTIONS *****/
    // Draw the background with gradient and clouds
    function drawBackground() {
      // Background gradient
      const grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
      grad.addColorStop(0, "#87ceeb");
      grad.addColorStop(1, "#ffffff");
      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Draw clouds
      clouds.forEach(cloud => {
        drawCloud(cloud);
      });
    }

    /***** GAME LOOP *****/
    function loop(timestamp) {
      if (gameOver) return;
      const deltaTime = timestamp - lastTime;
      lastTime = timestamp;

      // Update cloud positions
      clouds.forEach((cloud, i) => {
        cloud.x -= cloud.speed;
        // Remove off-screen clouds
        if (cloud.x + 60 * cloud.scale < 0) {
          clouds.splice(i, 1);
        }
      });

      // Draw background (gradient + clouds)
      drawBackground();

      // Update bird physics
      bird.velocity += GRAVITY;
      bird.y += bird.velocity;
      ctx.drawImage(birdImg, bird.x, bird.y, bird.width, bird.height);

      // Spawn pipes at intervals
      if (timestamp - lastPipeTime > PIPE_INTERVAL) {
        spawnPipe();
        lastPipeTime = timestamp;
      }
      // Update and draw pipes
      for (let i = pipes.length - 1; i >= 0; i--) {
        const pipe = pipes[i];
        pipe.x -= 2; // pipe speed
        if (pipe.isTop) {
          ctx.drawImage(pipeNorthImg, pipe.x, pipe.y);
          // Collision with top pipe
          if (detectCollision(bird, { x: pipe.x, y: pipe.y, width: pipeNorthImg.width, height: pipeNorthImg.height })) {
            endGame();
          }
        } else {
          ctx.drawImage(pipeSouthImg, pipe.x, pipe.y);
          // Collision with bottom pipe
          if (detectCollision(bird, { x: pipe.x, y: pipe.y, width: pipeSouthImg.width, height: pipeSouthImg.height })) {
            endGame();
          }
        }
        // Remove off-screen pipes
        if (pipe.x + PIPE_WIDTH < 0) {
          pipes.splice(i, 1);
        }
      }

      // Spawn coins at intervals
      if (timestamp - lastCoinTime > COIN_INTERVAL) {
        spawnCoin();
        lastCoinTime = timestamp;
      }
      // Update and draw coins
      for (let i = coins.length - 1; i >= 0; i--) {
        const coin = coins[i];
        coin.x -= 2; // same speed as pipes
        // Choose image based on coin type
        let coinImgToDraw = coin.type === "gold" ? goldCoinImg : diamondImg;
        ctx.drawImage(coinImgToDraw, coin.x, coin.y, COIN_SIZE, COIN_SIZE);
        
        // Check for collision with bird (collect coin)
        if (!coin.collected && detectCollision(bird, { x: coin.x, y: coin.y, width: COIN_SIZE, height: COIN_SIZE })) {
          coin.collected = true;
          playBeep(600, 0.1);
          // Award points: gold gives 10, diamond gives 20
          score += (coin.type === "gold" ? 10 : 20);
          scoreBoard.textContent = "Score: " + score;
        }
        // Remove coins that are off-screen or collected
        if (coin.x + COIN_SIZE < 0 || coin.collected) {
          coins.splice(i, 1);
        }
      }

      // Check if the bird hits the ground or goes off the top
      if (bird.y + bird.height > canvas.height || bird.y < 0) {
        endGame();
      }

      requestAnimationFrame(loop);
    }

    // Start the game loop
    requestAnimationFrame(loop);
  </script>
</body>
</html>
